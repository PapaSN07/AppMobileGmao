<p-tabs value="0" class="card">
    <p-toast />
    <p-confirmdialog [style]="{ width: '450px' }" />

    <p-tablist>
        <p-tab value="0">Ajouter des équipements</p-tab>
        <p-tab value="1">Modifier des équipements</p-tab>
        <p-tab value="2">Injection des équipements</p-tab>
    </p-tablist>
    <p-tabpanels>
        <p-tabpanel value="0">
            <div>
                <div class="font-semibold text-xl mb-4">Liste des équipements à approuver</div>

                <div>
                    <p-table
                        #dt1
                        [value]="equipmentsNoApproved()"
                        dataKey="id"
                        [rows]="5"
                        [rowsPerPageOptions]="[5, 10, 25, 50]"
                        [rowHover]="true"
                        [expandedRowKeys]="expandedRows"
                        [loading]="loading"
                        [paginator]="true"
                        [(selection)]="selectedEquipmentsNoApproved"
                        [globalFilterFields]="['centreCharge', 'code', 'codeParent', 'createdAt', 'createdBy', 'description', 'entity', 'famille', 'feeder', 'feederDescription', 'localisation', 'unite', 'zone']"
                        [tableStyle]="{ 'min-width': '75rem' }"
                        [scrollable]="true"
                    >
                        <ng-template #caption>
                            <div class="flex justify-between md:flex-row flex-col gap-2">
                                <div class="flex gap-2">
                                    <p-button 
                                        label="Approuver la sélection" 
                                        icon="pi pi-check" 
                                        severity="success" 
                                        (onClick)="saveAllEquipmentAdd()" 
                                        [disabled]="!selectedEquipmentsNoApproved || selectedEquipmentsNoApproved.length === 0" 
                                    />
                                    <p-button 
                                        label="Rejeter la sélection" 
                                        icon="pi pi-times" 
                                        severity="danger" 
                                        (onClick)="rejectAllEquipmentAdd()" 
                                        [disabled]="!selectedEquipmentsNoApproved || selectedEquipmentsNoApproved.length === 0" 
                                    />
                                </div>
                                <p-iconfield iconPosition="left" class="ml-auto">
                                    <p-inputicon>
                                        <i class="pi pi-search"></i>
                                    </p-inputicon>
                                    <input 
                                        pInputText 
                                        type="text" 
                                        (input)="dt1.filterGlobal($any($event.target).value, 'contains')" 
                                        placeholder="Rechercher..." 
                                    />
                                </p-iconfield>
                            </div>
                        </ng-template>

                        <ng-template #header>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"></th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="code" 
                                        placeholder="Rechercher par code..." 
                                        ariaLabel="Filtre Code" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="description" 
                                        placeholder="Rechercher par description..." 
                                        ariaLabel="Filtre Description" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="entity" 
                                        placeholder="Rechercher par entité..." 
                                        ariaLabel="Filtre Entité" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="famille" 
                                        placeholder="Rechercher par famille..." 
                                        ariaLabel="Filtre Famille" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="localisation" 
                                        placeholder="Rechercher par localisation..." 
                                        ariaLabel="Filtre Localisation" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="createdBy" 
                                        placeholder="Rechercher par créateur..." 
                                        ariaLabel="Filtre Créateur" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>Date création</th>
                                <th style="width: auto; min-width: 11.5rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen"></th>
                            </tr>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Entité</th>
                                <th>Famille</th>
                                <th>Localisation</th>
                                <th>Créé par</th>
                                <th>Date création</th>
                                <th style="width: auto; min-width: 11.5rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen">Actions</th>
                            </tr>
                        </ng-template>

                        <ng-template #body let-equipment let-expanded="expanded">
                            <tr>
                                <td>
                                    <p-button 
                                        type="button" 
                                        pRipple 
                                        [pRowToggler]="equipment" 
                                        [text]="true" 
                                        severity="secondary" 
                                        [rounded]="true" 
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" 
                                    />
                                </td>
                                <td>
                                    <p-tableCheckbox [value]="equipment" />
                                </td>
                                <td>
                                    <span class="font-semibold">{{ equipment.code || 'N/A' }}</span>
                                </td>
                                <td>{{ equipment.description || 'N/A' }}</td>
                                <td>{{ equipment.entity || 'N/A' }}</td>
                                <td>{{ equipment.famille || 'N/A' }}</td>
                                <td>{{ equipment.localisation || 'N/A' }}</td>
                                <td>{{ equipment.createdBy || 'N/A' }}</td>
                                <td>{{ equipment.createdAt | date:'dd/MM/yyyy' }}</td>
                                <td alignFrozen="right" pFrozenColumn [frozen]="balanceFrozen" class="p-2">
                                    <p-button 
                                        icon="pi pi-eye" 
                                        severity="info" 
                                        class="mr-2" 
                                        [rounded]="true" 
                                        [outlined]="true" 
                                        (click)="viewDetails(equipment)" 
                                        pTooltip="Voir les détails" 
                                        tooltipPosition="top" 
                                    />
                                    <p-button 
                                        (onClick)="confirm1($event, equipment)" 
                                        class="mr-2" 
                                        icon="pi pi-check" 
                                        [outlined]="true" 
                                        [rounded]="true"
                                        pTooltip="Approuver"
                                        tooltipPosition="top"
                                    />
                                    <p-button 
                                        (onClick)="confirm2($event, equipment)" 
                                        icon="pi pi-times" 
                                        severity="danger" 
                                        [outlined]="true" 
                                        [rounded]="true"
                                        pTooltip="Rejeter"
                                        tooltipPosition="top"
                                    />
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #expandedrow let-equipment>
                            <tr>
                                <td colspan="10">
                                    <div class="p-4">
                                        <div class="mb-4">
                                            <h5 class="font-semibold mb-2">Informations complètes</h5>
                                            <div class="grid grid-cols-3 gap-3">
                                                <div>
                                                    <span class="font-semibold">Centre Charge:</span>
                                                    <span class="ml-2">{{ equipment.centreCharge || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Code Parent:</span>
                                                    <span class="ml-2">{{ equipment.codeParent || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Feeder:</span>
                                                    <span class="ml-2">{{ equipment.feeder || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Feeder Description:</span>
                                                    <span class="ml-2">{{ equipment.feederDescription || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Unité:</span>
                                                    <span class="ml-2">{{ equipment.unite || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Zone:</span>
                                                    <span class="ml-2">{{ equipment.zone || 'N/A' }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        @if (equipment.attributes && equipment.attributes.length > 0) {
                                        <div>
                                            <h5 class="font-semibold mb-3">Attributs de {{ equipment.code }}</h5>
                                            <p-table [value]="equipment.attributes" dataKey="id">
                                                <ng-template #header>
                                                    <tr>
                                                        <th pSortableColumn="indx">
                                                            <div class="flex items-center gap-2">
                                                                Index
                                                                <p-sortIcon field="indx" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="specification">
                                                            <div class="flex items-center gap-2">
                                                                Spécification
                                                                <p-sortIcon field="specification" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="attributeName">
                                                            <div class="flex items-center gap-2">
                                                                Nom
                                                                <p-sortIcon field="attributeName" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="value">
                                                            <div class="flex items-center gap-2">
                                                                Valeur
                                                                <p-sortIcon field="value" />
                                                            </div>
                                                        </th>
                                                    </tr>
                                                </ng-template>
                                                <ng-template #body let-attribute>
                                                    <tr>
                                                        <td>{{ attribute.indx }}</td>
                                                        <td>{{ attribute.specification }}</td>
                                                        <td>{{ attribute.attributeName }}</td>
                                                        <td>{{ attribute.value }}</td>
                                                    </tr>
                                                </ng-template>
                                            </p-table>
                                        </div>
                                        } @else {
                                        <div class="text-center text-muted-color py-4">
                                            <i class="pi pi-inbox text-3xl mb-2"></i>
                                            <p>Aucun attribut disponible</p>
                                        </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #loadingbody>
                            <tr>
                                <td colspan="10" class="text-center py-8">
                                    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                                    <p class="mt-3">Chargement des données...</p>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #emptymessage>
                            <tr>
                                <td colspan="10" class="text-center py-8">
                                    <i class="pi pi-inbox text-4xl text-muted-color mb-3"></i>
                                    <p class="text-muted-color">Aucun équipement à approuver</p>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </p-tabpanel>

        <p-tabpanel value="1">
            <div>
                <div class="font-semibold text-xl mb-4">Modification des équipements à approuver</div>

                <div>
                    <p-table
                        #dt2
                        [value]="equipmentsNoModified()"
                        dataKey="id"
                        [rows]="5"
                        [rowsPerPageOptions]="[5, 10, 25, 50]"
                        [rowHover]="true"
                        [expandedRowKeys]="expandedRows"
                        [loading]="loading"
                        [paginator]="true"
                        [(selection)]="selectedEquipmentsNoModified"
                        [globalFilterFields]="['centreCharge', 'code', 'codeParent', 'createdAt', 'createdBy', 'description', 'entity', 'famille', 'feeder', 'feederDescription', 'localisation', 'unite', 'zone', 'updatedBy']"
                        [tableStyle]="{ 'min-width': '75rem' }"
                        [scrollable]="true"
                    >
                        <ng-template #caption>
                            <div class="flex justify-between md:flex-row flex-col gap-2">
                                <div class="flex gap-2">
                                    <p-button 
                                        label="Approuver la sélection" 
                                        icon="pi pi-check" 
                                        severity="success" 
                                        (onClick)="saveAllEquipmentUpdate()" 
                                        [disabled]="!selectedEquipmentsNoModified || selectedEquipmentsNoModified.length === 0" 
                                    />
                                    <p-button 
                                        label="Rejeter la sélection" 
                                        icon="pi pi-times" 
                                        severity="danger" 
                                        (onClick)="rejectAllEquipmentUpdate()" 
                                        [disabled]="!selectedEquipmentsNoModified || selectedEquipmentsNoModified.length === 0" 
                                    />
                                </div>
                                <p-iconfield iconPosition="left" class="ml-auto">
                                    <p-inputicon>
                                        <i class="pi pi-search"></i>
                                    </p-inputicon>
                                    <input 
                                        pInputText 
                                        type="text" 
                                        (input)="dt2.filterGlobal($any($event.target).value, 'contains')" 
                                        placeholder="Rechercher..." 
                                    />
                                </p-iconfield>
                            </div>
                        </ng-template>

                        <ng-template #header>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"></th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="code" 
                                        placeholder="Rechercher par code..." 
                                        ariaLabel="Filtre Code" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="description" 
                                        placeholder="Rechercher par description..." 
                                        ariaLabel="Filtre Description" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="entity" 
                                        placeholder="Rechercher par entité..." 
                                        ariaLabel="Filtre Entité" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="famille" 
                                        placeholder="Rechercher par famille..." 
                                        ariaLabel="Filtre Famille" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="localisation" 
                                        placeholder="Rechercher par localisation..." 
                                        ariaLabel="Filtre Localisation" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="updatedBy" 
                                        placeholder="Rechercher par modificateur..." 
                                        ariaLabel="Filtre Modificateur" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>Date modification</th>
                                <th style="width: auto; min-width: 11.5rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen"></th>
                            </tr>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Entité</th>
                                <th>Famille</th>
                                <th>Localisation</th>
                                <th>Modifié par</th>
                                <th>Date modification</th>
                                <th style="width: auto; min-width: 11.5rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen">Actions</th>
                            </tr>
                        </ng-template>

                        <ng-template #body let-equipment let-expanded="expanded">
                            <tr>
                                <td>
                                    <p-button 
                                        type="button" 
                                        pRipple 
                                        [pRowToggler]="equipment" 
                                        [text]="true" 
                                        severity="secondary" 
                                        [rounded]="true" 
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" 
                                    />
                                </td>
                                <td>
                                    <p-tableCheckbox [value]="equipment" />
                                </td>
                                <td>
                                    <span class="font-semibold">{{ equipment.code || 'N/A' }}</span>
                                </td>
                                <td>{{ equipment.description || 'N/A' }}</td>
                                <td>{{ equipment.entity || 'N/A' }}</td>
                                <td>{{ equipment.famille || 'N/A' }}</td>
                                <td>{{ equipment.localisation || 'N/A' }}</td>
                                <td>{{ equipment.updatedBy || 'N/A' }}</td>
                                <td>{{ equipment.updatedAt | date:'dd/MM/yyyy' }}</td>
                                <td alignFrozen="right" pFrozenColumn [frozen]="balanceFrozen" class="p-2">
                                    <p-button 
                                        icon="pi pi-eye" 
                                        severity="info" 
                                        class="mr-2" 
                                        [rounded]="true" 
                                        [outlined]="true" 
                                        (click)="viewDetails(equipment)" 
                                        pTooltip="Voir les détails" 
                                        tooltipPosition="top" 
                                    />
                                    <p-button 
                                        (onClick)="confirm3($event, equipment)" 
                                        class="mr-2" 
                                        icon="pi pi-check" 
                                        [outlined]="true" 
                                        [rounded]="true"
                                        pTooltip="Approuver"
                                        tooltipPosition="top"
                                    />
                                    <p-button 
                                        (onClick)="confirm4($event, equipment)" 
                                        icon="pi pi-times" 
                                        severity="danger" 
                                        [outlined]="true" 
                                        [rounded]="true"
                                        pTooltip="Rejeter"
                                        tooltipPosition="top"
                                    />
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #expandedrow let-equipment>
                            <tr>
                                <td colspan="10">
                                    <div class="p-4">
                                        <div class="mb-4">
                                            <h5 class="font-semibold mb-2">Informations complètes</h5>
                                            <div class="grid grid-cols-3 gap-3">
                                                <div>
                                                    <span class="font-semibold">Centre Charge:</span>
                                                    <span class="ml-2">{{ equipment.centreCharge || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Code Parent:</span>
                                                    <span class="ml-2">{{ equipment.codeParent || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Feeder:</span>
                                                    <span class="ml-2">{{ equipment.feeder || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Feeder Description:</span>
                                                    <span class="ml-2">{{ equipment.feederDescription || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Unité:</span>
                                                    <span class="ml-2">{{ equipment.unite || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Zone:</span>
                                                    <span class="ml-2">{{ equipment.zone || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Créé par:</span>
                                                    <span class="ml-2">{{ equipment.createdBy || 'N/A' }}</span>
                                                </div>
                                                <div>
                                                    <span class="font-semibold">Créé le:</span>
                                                    <span class="ml-2">{{ equipment.createdAt | date:'dd/MM/yyyy' }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        @if (equipment.attributes && equipment.attributes.length > 0) {
                                        <div>
                                            <h5 class="font-semibold mb-3">Attributs de {{ equipment.code }}</h5>
                                            <p-table [value]="equipment.attributes" dataKey="id">
                                                <ng-template #header>
                                                    <tr>
                                                        <th pSortableColumn="indx">
                                                            <div class="flex items-center gap-2">
                                                                Index
                                                                <p-sortIcon field="indx" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="specification">
                                                            <div class="flex items-center gap-2">
                                                                Spécification
                                                                <p-sortIcon field="specification" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="attributeName">
                                                            <div class="flex items-center gap-2">
                                                                Nom
                                                                <p-sortIcon field="attributeName" />
                                                            </div>
                                                        </th>
                                                        <th pSortableColumn="value">
                                                            <div class="flex items-center gap-2">
                                                                Valeur
                                                                <p-sortIcon field="value" />
                                                            </div>
                                                        </th>
                                                    </tr>
                                                </ng-template>
                                                <ng-template #body let-attribute>
                                                    <tr>
                                                        <td>{{ attribute.indx }}</td>
                                                        <td>{{ attribute.specification }}</td>
                                                        <td>{{ attribute.attributeName }}</td>
                                                        <td>{{ attribute.value }}</td>
                                                    </tr>
                                                </ng-template>
                                            </p-table>
                                        </div>
                                        } @else {
                                        <div class="text-center text-muted-color py-4">
                                            <i class="pi pi-inbox text-3xl mb-2"></i>
                                            <p>Aucun attribut disponible</p>
                                        </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #loadingbody>
                            <tr>
                                <td colspan="10" class="text-center py-8">
                                    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                                    <p class="mt-3">Chargement des données...</p>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template #emptymessage>
                            <tr>
                                <td colspan="10" class="text-center py-8">
                                    <i class="pi pi-inbox text-4xl text-muted-color mb-3"></i>
                                    <p class="text-muted-color">Aucune modification à approuver</p>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </p-tabpanel>

        <p-tabpanel value="2">
            <div>
                <div class="font-semibold text-xl mb-4">Instance d'injection des équipements</div>

                <div>
                    <p-table
                        #dt3
                        [value]="equipmentsApproved()"
                        dataKey="id"
                        [rows]="5"
                        [rowsPerPageOptions]="[5, 10, 25, 50]"
                        [rowHover]="true"
                        [expandedRowKeys]="expandedRows"
                        [loading]="loading"
                        [paginator]="true"
                        [(selection)]="selectedEquipmentsExport"
                        [globalFilterFields]="['centreCharge', 'code', 'codeParent', 'createdAt', 'createdBy', 'description', 'entity', 'famille', 'feeder', 'feederDescription', 'localisation', 'unite', 'zone' ]"
                        [tableStyle]="{ 'min-width': '75rem' }"
                        [scrollable]="true"
                    >
                        <ng-template #caption>
                            <div class="flex justify-between md:flex-row flex-col gap-2">
                                <p-button 
                                    label="Exporter sélection" 
                                    icon="pi pi-upload" 
                                    severity="secondary" 
                                    (onClick)="exportExcelTable()" 
                                    [disabled]="!selectedEquipmentsExport || selectedEquipmentsExport.length === 0" 
                                />
                                <p-iconfield iconPosition="left" class="ml-auto">
                                    <p-inputicon>
                                        <i class="pi pi-search"></i>
                                    </p-inputicon>
                                    <input 
                                        pInputText 
                                        type="text" 
                                        (input)="dt3.filterGlobal($any($event.target).value, 'contains')" 
                                        placeholder="Search keyword" 
                                    />
                                </p-iconfield>
                            </div>
                        </ng-template>

                        <ng-template #header>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"></th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="centreCharge" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Centre Charge" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="code" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Code" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="codeParent" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Code Parent" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="description" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Description" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="entity" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Entité" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="famille" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Famille" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="feeder" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Feeder" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="feederDescription" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Feeder Description" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="localisation" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Localisation" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="unite" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Unité" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                                <th>
                                    <p-columnFilter 
                                        type="text" 
                                        field="zone" 
                                        placeholder="Rechercher par ..." 
                                        ariaLabel="Filtre Zone" 
                                        filterOn="input"
                                    ></p-columnFilter>
                                </th>
                            </tr>
                            <tr>
                                <th style="width: 4rem"></th>
                                <th style="width: 4rem"><p-tableHeaderCheckbox /></th>
                                <th style="width: 11%">Centre Charge</th>
                                <th style="width: 11%">Code</th>
                                <th style="width: 11%">Code Parent</th>
                                <th style="width: 11%">Description</th>
                                <th style="width: 11%">Entité</th>
                                <th style="width: 11%">Famille</th>
                                <th style="width: 11%">Feeder</th>
                                <th style="width: 11%">Feeder Description</th>
                                <th style="width: 11%">Localisation</th>
                                <th style="width: 11%">Unité</th>
                                <th style="width: 11%">Zone</th>
                                <th style="width: auto; min-width: 8rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen">Actions</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-equipment let-expanded="expanded">
                            <tr>
                                <td>
                                    <p-button type="button" pRipple [pRowToggler]="equipment" [text]="true" severity="secondary" [rounded]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                                </td>
                                <td>
                                    <p-tableCheckbox [value]="equipment" />
                                </td>
                                <td>{{ equipment.centreCharge || 'N/A' }}</td>
                                <td>{{ equipment.code || 'N/A' }}</td>
                                <td>{{ equipment.codeParent || 'N/A' }}</td>
                                <td>{{ equipment.description || 'N/A' }}</td>
                                <td>{{ equipment.entity || 'N/A' }}</td>
                                <td>{{ equipment.famille || 'N/A' }}</td>
                                <td>{{ equipment.feeder || 'N/A' }}</td>
                                <td>{{ equipment.feederDescription || 'N/A' }}</td>
                                <td>{{ equipment.localisation || 'N/A' }}</td>
                                <td>{{ equipment.unite || 'N/A' }}</td>
                                <td>{{ equipment.zone || 'N/A' }}</td>
                                <td alignFrozen="right" pFrozenColumn [frozen]="balanceFrozen" class="p-2">
                                    <p-button 
                                        icon="pi pi-eye" 
                                        severity="info" 
                                        class="mr-2" 
                                        [rounded]="true" 
                                        [outlined]="true" 
                                        (click)="viewDetails(equipment)" 
                                        pTooltip="Voir" 
                                        tooltipPosition="top" 
                                    />
                                    <p-button 
                                        (onClick)="confirmDelete($event, equipment)" 
                                        icon="pi pi-trash" 
                                        severity="danger" 
                                        [outlined]="true" 
                                        [rounded]="true"
                                        pTooltip="Supprimer"
                                        tooltipPosition="top"
                                    />
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template #expandedrow let-equipment>
                            <tr>
                                <td colspan="14">
                                    <div class="p-4">
                                        <h5>Attributes pour {{ equipment.code }}</h5>
                                        <p-table [value]="equipment.attributes" dataKey="id">
                                            <ng-template #header>
                                                <tr>
                                                    <th pSortableColumn="indx">
                                                        <div class="flex items-center gap-2">
                                                            Index
                                                            <p-sortIcon field="indx" />
                                                        </div>
                                                    </th>
                                                    <th pSortableColumn="specification">
                                                        <div class="flex items-center gap-2">
                                                            Spécification
                                                            <p-sortIcon field="specification" />
                                                        </div>
                                                    </th>
                                                    <th pSortableColumn="attributeName">
                                                        <div class="flex items-center gap-2">
                                                            Nom
                                                            <p-sortIcon field="attributeName" />
                                                        </div>
                                                    </th>
                                                    <th pSortableColumn="value">
                                                        <div class="flex items-center gap-2">
                                                            Valeur
                                                            <p-sortIcon field="value" />
                                                        </div>
                                                    </th>
                                                </tr>
                                            </ng-template>
                                            <ng-template #body let-attribute>
                                                <tr>
                                                    <td>{{ attribute.indx }}</td>
                                                    <td>{{ attribute.specification }}</td>
                                                    <td>{{ attribute.attributeName }}</td>
                                                    <td>{{ attribute.value }}</td>
                                                </tr>
                                            </ng-template>
                                            <ng-template #emptymessage>
                                                <tr>
                                                    <td colspan="4">Ses attributs sont vides. 🚫🚫🚫</td>
                                                </tr>
                                            </ng-template>
                                        </p-table>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template #loadingbody>
                            <tr>
                                <td colspan="14">Chargement des données des clients. Veuillez patienter 🫸🏽🫸🏽🫸🏽.</td>
                            </tr>
                        </ng-template>
                        <ng-template #emptymessage>
                            <tr>
                                <td colspan="14">Pas de données disponibles 😔😔😔.</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </p-tabpanel>
    </p-tabpanels>

    <!-- ✅ DIALOGS PARTAGÉS - Placés en dehors des tabs pour être accessibles partout -->
    <!-- Dialog de visualisation - Unique et partagé entre tous les onglets -->
    <p-dialog 
        [(visible)]="detailsDialog" 
        [modal]="true" 
        [style]="{ width: '700px' }" 
        header="Détails de l'équipement" 
        [draggable]="false" 
        [resizable]="false"
    >
        <ng-template pTemplate="content">
            <div class="flex flex-col gap-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-bold mb-2">Code</label>
                        <input pInputText [value]="selectedEquipment?.code" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Centre Charge</label>
                        <input pInputText [value]="selectedEquipment?.centreCharge" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Localisation</label>
                        <input pInputText [value]="selectedEquipment?.localisation" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Famille</label>
                        <input pInputText [value]="selectedEquipment?.famille" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Entité</label>
                        <input pInputText [value]="selectedEquipment?.entity" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Code Parent</label>
                        <input pInputText [value]="selectedEquipment?.codeParent" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Feeder</label>
                        <input pInputText [value]="selectedEquipment?.feeder" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Zone</label>
                        <input pInputText [value]="selectedEquipment?.zone" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Unité</label>
                        <input pInputText [value]="selectedEquipment?.unite" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Créé par</label>
                        <input pInputText [value]="selectedEquipment?.createdBy" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Créé le</label>
                        <input pInputText [value]="selectedEquipment?.createdAt | date:'dd/MM/yyyy'" disabled class="w-full" />
                    </div>
                    @if (selectedEquipment?.judgedBy) {
                    <div>
                        <label class="block font-bold mb-2">Modifié par</label>
                        <input pInputText [value]="selectedEquipment?.judgedBy" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Modifié le</label>
                        <input pInputText [value]="selectedEquipment?.updatedAt | date:'dd/MM/yyyy'" disabled class="w-full" />
                    </div>
                    }
                    <div>
                        <label class="block font-bold mb-2">Statut Approbation</label>
                        <p-tag 
                            [value]="selectedEquipment?.isApproved ? 'Approuvé' : 'Non approuvé'" 
                            [severity]="selectedEquipment?.isApproved ? 'success' : 'warn'" 
                        />
                    </div>
                    <div class="col-span-2">
                        <label class="block font-bold mb-2">Description</label>
                        <textarea pTextarea [value]="selectedEquipment?.description" rows="3" disabled class="w-full"></textarea>
                    </div>
                </div>

                @if (selectedEquipment && selectedEquipment.attributes && selectedEquipment.attributes.length > 0) {
                <div class="mt-4">
                    <h5 class="font-semibold mb-3">Attributs</h5>
                    <p-table 
                        [value]="selectedEquipment.attributes" 
                        [tableStyle]="{ 'min-width': '40rem' }" 
                        dataKey="id"
                    >
                        <ng-template #header>
                            <tr>
                                <th>Index</th>
                                <th>Spécification</th>
                                <th>Nom</th>
                                <th>Valeur</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-attr>
                            <tr>
                                <td>{{ attr.indx }}</td>
                                <td>{{ attr.specification }}</td>
                                <td>{{ attr.attributeName }}</td>
                                <td>{{ attr.value }}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
                } @else {
                <div class="text-center text-muted-color py-4">
                    <i class="pi pi-inbox text-3xl mb-2"></i>
                    <p>Aucun attribut disponible</p>
                </div>
                }
            </div>
        </ng-template>

        <ng-template pTemplate="footer">
            <p-button 
                label="Fermer" 
                icon="pi pi-times" 
                text 
                (click)="hideDetails()" 
            />
        </ng-template>
    </p-dialog>

    <!-- Dialog de rejet en masse - Partagé entre Tab 0 et Tab 1 -->
    <p-dialog 
        [(visible)]="bulkRejectDialog" 
        [modal]="true" 
        [style]="{ width: '800px' }" 
        header="Rejet en masse - Commentaires" 
        [draggable]="false" 
        [resizable]="false"
    >
        <ng-template pTemplate="content">
            <div class="p-4">
                <p-table [value]="bulkRejectEquipments" dataKey="equipment.id" [tableStyle]="{ 'min-width': '60rem' }">
                    <ng-template #header>
                        <tr>
                            <th>Code Équipement</th>
                            <th>Description</th>
                            <th>Commentaire de rejet</th>
                        </tr>
                    </ng-template>
                    <ng-template #body let-item>
                        <tr>
                            <td>{{ item.equipment.code }}</td>
                            <td>{{ item.equipment.description }}</td>
                            <td>
                                <textarea 
                                    pTextarea 
                                    [(ngModel)]="item.comment" 
                                    rows="2" 
                                    placeholder="Motif du rejet (optionnel)"
                                    class="w-full"
                                ></textarea>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </ng-template>

        <ng-template pTemplate="footer">
            <p-button 
                label="Annuler" 
                icon="pi pi-times" 
                text 
                (click)="cancelBulkReject()" 
            />
            <p-button 
                label="Rejeter" 
                icon="pi pi-times" 
                severity="danger" 
                (click)="submitBulkReject()" 
            />
        </ng-template>
    </p-dialog>

    <!-- Dialog de rejet unitaire - Partagé entre Tab 0 et Tab 1 -->
    <p-dialog 
        [(visible)]="singleRejectDialog" 
        [modal]="true" 
        [style]="{ width: '500px' }" 
        header="Motif du rejet" 
        [draggable]="false" 
        [resizable]="false"
    >
        <ng-template pTemplate="content">
            <div class="p-4">
                <label for="singleRejectComment" class="block font-bold mb-2">Commentaire (optionnel)</label>
                <textarea 
                    pTextarea 
                    id="singleRejectComment" 
                    [(ngModel)]="singleRejectComment" 
                    rows="4" 
                    placeholder="Saisissez le motif du rejet..." 
                    class="w-full"
                ></textarea>
            </div>
        </ng-template>

        <ng-template pTemplate="footer">
            <p-button 
                label="Annuler" 
                icon="pi pi-times" 
                text 
                (click)="cancelSingleReject()" 
            />
            <p-button 
                label="Rejeter" 
                icon="pi pi-times" 
                severity="danger" 
                (click)="submitSingleReject()" 
            />
        </ng-template>
    </p-dialog>
</p-tabs>
