<div class="card">
    <div class="font-semibold text-xl mb-4">Historique des équipements</div>

    <p-table
        #dt
        [value]="equipments"
        dataKey="id"
        [rows]="5"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        [rowHover]="true"
        [expandedRowKeys]="expandedRows"
        [loading]="loading"
        [paginator]="true"
        [globalFilterFields]="['code', 'description', 'entity', 'famille', 'createdBy', 'updatedBy', 'deletedBy']"
        [tableStyle]="{ 'min-width': '75rem' }"
        [scrollable]="true"
    >
        <ng-template #caption>
            <div class="flex justify-end">
                <p-iconfield iconPosition="left">
                    <p-inputicon>
                        <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                        placeholder="Rechercher..." 
                    />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th style="width: 4rem"></th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="code" 
                        placeholder="Rechercher par code..." 
                        ariaLabel="Filtre Code" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="description" 
                        placeholder="Rechercher par description..." 
                        ariaLabel="Filtre Description" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="entity" 
                        placeholder="Rechercher par entité..." 
                        ariaLabel="Filtre Entité" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="famille" 
                        placeholder="Rechercher par famille..." 
                        ariaLabel="Filtre Famille" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>Statut</th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="createdBy" 
                        placeholder="Rechercher par créateur..." 
                        ariaLabel="Filtre Créateur" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>Date création</th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="updatedBy" 
                        placeholder="Rechercher par modificateur..." 
                        ariaLabel="Filtre Modificateur" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th>Date modification</th>
                <th>
                    <p-columnFilter 
                        type="text" 
                        field="deletedBy" 
                        placeholder="Rechercher par suppresseur..." 
                        ariaLabel="Filtre Suppresseur" 
                        filterOn="input"
                    ></p-columnFilter>
                </th>
                <th style="width: auto; min-width: 8rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen"></th>
            </tr>
            <tr>
                <th style="width: 4rem"></th>
                <th>Code</th>
                <th>Description</th>
                <th>Entité</th>
                <th>Famille</th>
                <th>Statut</th>
                <th>Créé par</th>
                <th>Date création</th>
                <th>Modifié par</th>
                <th>Date modification</th>
                <th>Supprimé par</th>
                <th style="width: auto; min-width: 8rem" pFrozenColumn alignFrozen="right" [frozen]="balanceFrozen">Actions</th>
            </tr>
        </ng-template>

        <ng-template #body let-equipment let-expanded="expanded">
            <tr [ngClass]="getRowClass(equipment)">
                <td>
                    <p-button 
                        type="button" 
                        pRipple 
                        [pRowToggler]="equipment" 
                        [text]="true" 
                        severity="secondary" 
                        [rounded]="true" 
                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" 
                    />
                </td>
                <td>
                    <span class="font-semibold">{{ equipment.code || 'N/A' }}</span>
                </td>
                <td>{{ equipment.description || 'N/A' }}</td>
                <td>{{ equipment.entity || 'N/A' }}</td>
                <td>{{ equipment.famille || 'N/A' }}</td>
                <td>
                    <p-tag 
                        [severity]="getStatusTag(equipment).severity" 
                        [value]="getStatusTag(equipment).value"
                        [icon]="getStatusTag(equipment).icon"
                    />
                </td>
                <td>{{ equipment.createdBy || 'N/A' }}</td>
                <td>{{ equipment.createdAt ? (equipment.createdAt | date:'dd/MM/yyyy') : 'N/A' }}</td>
                <td>{{ equipment.judgedBy || 'N/A' }}</td>
                <td>{{ equipment.updatedAt ? (equipment.updatedAt | date:'dd/MM/yyyy') : 'N/A' }}</td>
                <td>
                    @if (equipment.isDeleted) {
                        <span class="text-red-500 font-semibold">
                            <i class="pi pi-user mr-1"></i>
                            {{ equipment.judgedBy || 'N/A' }}
                        </span>
                    } @else {
                        <span class="text-muted-color">-</span>
                    }
                </td>
                <td alignFrozen="right" pFrozenColumn [frozen]="balanceFrozen" class="p-2">
                    <p-button 
                        icon="pi pi-eye" 
                        severity="info" 
                        [rounded]="true" 
                        [outlined]="true" 
                        (click)="viewDetails(equipment)" 
                        pTooltip="Voir les détails" 
                        tooltipPosition="top" 
                    />
                </td>
            </tr>
        </ng-template>

        <ng-template #expandedrow let-equipment>
            <tr>
                <td colspan="12">
                    <div class="p-4">
                        <div class="mb-4">
                            <h5 class="font-semibold mb-2">Informations complètes</h5>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <span class="font-semibold">Centre Charge:</span>
                                    <span class="ml-2">{{ equipment.centreCharge || 'N/A' }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Code Parent:</span>
                                    <span class="ml-2">{{ equipment.codeParent || 'N/A' }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Localisation:</span>
                                    <span class="ml-2">{{ equipment.localisation || 'N/A' }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Feeder:</span>
                                    <span class="ml-2">{{ equipment.feeder || 'N/A' }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Unité:</span>
                                    <span class="ml-2">{{ equipment.unite || 'N/A' }}</span>
                                </div>
                                <div>
                                    <span class="font-semibold">Zone:</span>
                                    <span class="ml-2">{{ equipment.zone || 'N/A' }}</span>
                                </div>
                            </div>
                        </div>

                        @if (equipment.attributes && equipment.attributes.length > 0) {
                        <div>
                            <h5 class="font-semibold mb-3">Attributs de {{ equipment.code }}</h5>
                            <p-table [value]="equipment.attributes" dataKey="id">
                                <ng-template #header>
                                    <tr>
                                        <th pSortableColumn="indx">
                                            <div class="flex items-center gap-2">
                                                Index
                                                <p-sortIcon field="indx" />
                                            </div>
                                        </th>
                                        <th pSortableColumn="specification">
                                            <div class="flex items-center gap-2">
                                                Spécification
                                                <p-sortIcon field="specification" />
                                            </div>
                                        </th>
                                        <th pSortableColumn="attributeName">
                                            <div class="flex items-center gap-2">
                                                Nom
                                                <p-sortIcon field="attributeName" />
                                            </div>
                                        </th>
                                        <th pSortableColumn="value">
                                            <div class="flex items-center gap-2">
                                                Valeur
                                                <p-sortIcon field="value" />
                                            </div>
                                        </th>
                                    </tr>
                                </ng-template>
                                <ng-template #body let-attribute>
                                    <tr>
                                        <td>{{ attribute.indx }}</td>
                                        <td>{{ attribute.specification }}</td>
                                        <td>{{ attribute.attributeName }}</td>
                                        <td>{{ attribute.value }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                        } @else {
                        <div class="text-center text-muted-color py-4">
                            <i class="pi pi-inbox text-3xl mb-2"></i>
                            <p>Aucun attribut disponible</p>
                        </div>
                        }
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template #loadingbody>
            <tr>
                <td colspan="12" class="text-center py-8">
                    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                    <p class="mt-3">Chargement de l'historique...</p>
                </td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <tr>
                <td colspan="12" class="text-center py-8">
                    <i class="pi pi-inbox text-4xl text-muted-color mb-3"></i>
                    <p class="text-muted-color">Aucun équipement dans l'historique</p>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- ✅ Dialog de visualisation -->
    <p-dialog 
        [(visible)]="detailsDialog" 
        [modal]="true" 
        [style]="{ width: '700px' }" 
        header="Détails de l'équipement" 
        [draggable]="false" 
        [resizable]="false"
    >
        <ng-template pTemplate="content">
            <div class="flex flex-col gap-4">
                <!-- Statut avec alerte si supprimé -->
                @if (selectedEquipment?.isDeleted) {
                <div class="bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-800 rounded p-3 mb-4">
                    <div class="flex items-center gap-2 text-red-700 dark:text-red-400">
                        <i class="pi pi-exclamation-triangle text-xl"></i>
                        <div>
                            <div class="font-semibold">Équipement supprimé</div>
                            <div class="text-sm">
                                Supprimé par {{ selectedEquipment?.judgedBy || 'Inconnu' }}
                                le {{ selectedEquipment?.updatedAt | date:'dd/MM/yyyy à' }}
                            </div>
                        </div>
                    </div>
                </div>
                }

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-bold mb-2">Code</label>
                        <input pInputText [value]="selectedEquipment?.code" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Statut</label>
                        <p-tag 
                            [severity]="getStatusTag(selectedEquipment!).severity" 
                            [value]="getStatusTag(selectedEquipment!).value"
                            [icon]="getStatusTag(selectedEquipment!).icon"
                        />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Centre Charge</label>
                        <input pInputText [value]="selectedEquipment?.centreCharge" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Localisation</label>
                        <input pInputText [value]="selectedEquipment?.localisation" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Famille</label>
                        <input pInputText [value]="selectedEquipment?.famille" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Entité</label>
                        <input pInputText [value]="selectedEquipment?.entity" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Code Parent</label>
                        <input pInputText [value]="selectedEquipment?.codeParent" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Feeder</label>
                        <input pInputText [value]="selectedEquipment?.feeder" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Zone</label>
                        <input pInputText [value]="selectedEquipment?.zone" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Unité</label>
                        <input pInputText [value]="selectedEquipment?.unite" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Créé par</label>
                        <input pInputText [value]="selectedEquipment?.createdBy" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Créé le</label>
                        <input pInputText [value]="selectedEquipment?.createdAt | date:'dd/MM/yyyy'" disabled class="w-full" />
                    </div>
                    @if (selectedEquipment?.judgedBy) {
                    <div>
                        <label class="block font-bold mb-2">Modifié par</label>
                        <input pInputText [value]="selectedEquipment?.judgedBy" disabled class="w-full" />
                    </div>
                    <div>
                        <label class="block font-bold mb-2">Modifié le</label>
                        <input pInputText [value]="selectedEquipment?.judgedBy | date:'dd/MM/yyyy'" disabled class="w-full" />
                    </div>
                    }
                    @if (selectedEquipment?.isDeleted && selectedEquipment?.judgedBy) {
                    <div>
                        <label class="block font-bold mb-2 text-red-600 dark:text-red-400">Supprimé par</label>
                        <input pInputText [value]="selectedEquipment?.judgedBy" disabled class="w-full bg-red-50 dark:bg-red-900/20" />
                    </div>
                    }
                    <div class="col-span-2">
                        <label class="block font-bold mb-2">Description</label>
                        <textarea pTextarea [value]="selectedEquipment?.description" rows="3" disabled class="w-full"></textarea>
                    </div>
                </div>

                @if (selectedEquipment && selectedEquipment.attributes && selectedEquipment.attributes.length > 0) {
                <div class="mt-4">
                    <h5 class="font-semibold mb-3">Attributs</h5>
                    <p-table 
                        [value]="selectedEquipment.attributes" 
                        [tableStyle]="{ 'min-width': '40rem' }" 
                        dataKey="id"
                    >
                        <ng-template #header>
                            <tr>
                                <th>Index</th>
                                <th>Spécification</th>
                                <th>Nom</th>
                                <th>Valeur</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-attr>
                            <tr>
                                <td>{{ attr.indx }}</td>
                                <td>{{ attr.specification }}</td>
                                <td>{{ attr.attributeName }}</td>
                                <td>{{ attr.value }}</td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
                }
            </div>
        </ng-template>

        <ng-template pTemplate="footer">
            <p-button 
                label="Fermer" 
                icon="pi pi-times" 
                text 
                (click)="hideDetails()" 
            />
        </ng-template>
    </p-dialog>
</div>
